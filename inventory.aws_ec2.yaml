---
plugin: aws_ec2
regions:
   - ap-south-1
filters:
  tag:Name:
    - "redis-public"
    - "redis-private-1"
    - "redis-private-2"
    - "redis-private-3"
  instance-state-name:
    - running
keyed_groups:
  # Group by instance name
  - key: tags.Name
    prefix: name
  # Group by subnet type
  - key: tags.Name | regex_replace('redis-', '')
    prefix: subnet
compose:
   ansible_host: public_ip_address if (tags.Name == "redis-public") else private_ip_address
   ansible_ssh_private_key_file: "./redis-infra-key.pem"
   ansible_ssh_user: ubuntu
   # For private instances, use bastion as jump host
   ansible_ssh_common_args: >-
     -o StrictHostKeyChecking=no 
     -o UserKnownHostsFile=/dev/null 
     -o ConnectTimeout=60
     {{ ('-o ProxyCommand="ssh -W %h:%p -i ./redis-infra-key.pem -o StrictHostKeyChecking=no ubuntu@' + hostvars[groups['name_redis_public'][0]]['public_ip_address'] + '"') if 'private' in tags.Name else '' }}
strict: False
cache: True
cache_timeout: 600
